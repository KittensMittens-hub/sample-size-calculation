---
title: "sample size"
author: "Natalya"
date: "2025-12-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
library(TrialSize)
sessionInfo()
```

Рассчитайте объёмы выборок для следующих клинических исследований.
Опишите предположения, которые были выдвинуты при анализе.
Воспользуйтесь примером оформления результатов, который приведён далее.
Частота выбывания пациентов в ходе исследования – 20%. Частота выбывания пациентов в ходе скрининга – 10%. Ошибку первого рода для односторонних гипотез установите на уровне 0.025,мощность – 80%.

# 1.
Исследование не меньшей эффективности препарата T в сравнении с препаратом R в лечении хронической обструктивной болезни лёгких (ХОБЛ). Первичная конечная точка – абсолютное увеличение индекса Тиффно (ОФВ1/ЖЕЛ) за 3 месяца терапии в сравнении со значениями на 1 визите. Из литературных данных известно, что для препарата R абсолютный прирост индекса за 3 месяца в среднем (M±SD) составлял 7.2 ± 3.1% (процентных пунктов – п.п.). Предлагаемая граница не меньшей эффективности – 2 % (п.п.).


Статистическая гипотеза не меньшей эффективности в исследовании была сформулирована следующим образом:  
H₀: Pт - Pс ≤ -δ  
Hₐ: Pт - Pс > -δ  

Где PT – абсолютное увеличение индекса Тиффно  за 3 месяца терапии в сравнении со значениями на 1 визите в группе препарата T, PС – то же в группе R. δ – граница не меньшей эффективности (2%).  
При расчёте необходимого размера выборки были сделаны следующие допущения:
1. Распределение в группы будет равномерным в соотношении 1:1;  
2. Односторонняя величина ошибки I рода (α) составляет 0.025;  
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;  
4. На основании литературных данных мы ожидаем величину эффекта в группе
препаратов 7.2 ± 3.1%  
5. Граница превосходства препарата по сравнению с активным контролем равна 2%.  
Расчёт размера выборки был проведён в RStudio (версия 2025.09.2 Build 418) c использованием языка R (версия 4.5.2) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4.1). Результаты расчёта представлены далее.  

```{r}
result <- TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 3.1,
    k = 1,
    delta = 0,
    margin = 2  
)

print(result) 

n_per_group <- result 
n_per_group_adjusted_1 <- ceiling(n_per_group / 0.9)

print(n_per_group_adjusted_1)

n_per_group_adjusted_2 <- ceiling(n_per_group_adjusted_1 / 0.8)

print(n_per_group_adjusted_2)
```
Таким образом, в каждую группу необходимо включить не менее 38 обследуемых, всего – 76 пациента.С учётом частоты выбывания пациентов в ходе исследования, равной 20%, в каждую группу необходимо набрать не менее 48 человек (всего 96) В скрининг (с учётом 10% выбывания) необходимо включить не менее 54 обследуемых в каждую группу (всего 108).

# 2 
Исследование превосходства препарата T над референтным лечением R в лечении
рассеянного склероза. Первичный показатель эффективности – доля пациентов, у которых к визиту 3 (12 мес.) нет новых очагов по МРТ, развившихся в период наблюдения. Согласно литературным данным, на фоне применения препарата R доля пациентов без новых очагов составляет 66%. Ожидается, что препарат T будет эффективнее препарата R примерно на 15% (п.п.), при этом спонсор хотел бы, чтобы граница превосходства была бы равна 1% (п.п.). Спонсор просит, чтобы в группу T было рандомизировано в 2 раза больше пациентов, чем в группу R.  

Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом:  
H0: PT – PС ≤ δ  
HA: PT – PС > δ  

Где PT – доля пациентов, у которых к визиту 3 нет новых очагов по МРТ на терапии T, PС – то же на терапии R.  δ – граница превосходства (1%).
При расчёте необходимого размера выборки были сделаны следующие допущения:  
1. Распределение в группы будет неравномерным в соотношении 2:1;  
2. Односторонняя величина ошибки I рода (α) составляет 0.025;  
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;  
4. На основании литературных данных мы ожидаем величину эффекта в группе
препарата R 66%, в группе препарата T - 66+15 = 81% (дельта = 15%)  
5. Граница превосходства препарата по сравнению с активным контролем равна 1%.  
Расчёт размера выборки был проведён в RStudio (версия 2025.09.2 Build 418) c использованием языка R (версия 4.5.2) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4.1). Результаты расчёта представлены далее.  

```{r}
?TwoSampleProportion.NIS


result2 <- TwoSampleProportion.NIS(
alpha = 0.025,
beta = 0.2,
p1 = 0.81,
p2 = 0.66,
k = 2,
delta = 0.15,
margin = 0.01
)

print(result2)

result2adj <- ceiling(result2 / 0.9)

print(result2adj)

result2adj2 <- ceiling(result2adj / 0.8)

print(result2adj2)
```
По расчетам: 242 - количество в группе Т, 120 в группе R (всего 362). С учетом выбывания 10% на скрининге 269 - количество в группе Т, 135 в группе R (всего 404). С учетом выбывания 20% в ходе исследования 337 - количество в группе Т, 169 в группе R (всего 506)


#3 
Исследование превосходства нового препарата А над препаратом Б в профилактике
интраоперационных кровотечений. Первичная конечная точка – объём кровопотери в мл. Из данных литературы известно, что средний объём кровопотери при применении препарата Б составляет 306 ± 52 мл. Ожидается, что препарат А в среднем будет снижать объём кровопотери на 20% в сравнении с препаратом Б. Границу превосходства предполагается установить равной 50 мл. Спонсор просит рассчитать объём выборок таким образом, чтобы препарат А получили 75% пациентов, включённых в исследование.  


Статистическая гипотеза превосхоства в исследовании была сформулирована следующим образом:  
H₀: Pт - Pс ≥ -δ  
Hₐ: Pт - Pс < -δ  

Где PT – объем кровопотери в группе А, PС – то же в группе Б. 
контрольной группе. δ – граница превосходства = 50  
При расчёте необходимого размера выборки были сделаны следующие допущения:  
1. Распределение в группы будет неравномерным в соотношении 3:1;  
2. Односторонняя величина ошибки I рода (α) составляет 0.025;  
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;  
4. На основании литературных данных мы ожидаем величину эффекта в группе
препарата Б 306 ± 52 мл, в группе А на 20% меньше = 244.8 ± 52 мл %  
5. Граница превосходства препарата по сравнению с активным контролем равна 50 мл.  
Расчёт размера выборки был проведён в RStudio (версия 2025.09.2 Build 418) c использованием языка R (версия 4.5.2) с помощью функции TwoSampleMean.NIS пакета TrialSize (версия 1.4.1). Результаты расчёта представлены далее.  

```{r}
result3 <- TwoSampleMean.NIS(
    alpha = 0.025,
    beta = 0.2,
    sigma = 52,
    k = 3,
    delta = -61.2,
    margin = -50  
)

print(result3) 

result3adj <- ceiling(result3 / 0.9)

print(result3adj)

result3adj2 <- ceiling(result3adj / 0.8)

print(result3adj2)
```
Таким образом, в группу А необходимо включить 677 пациентов, в группу Б - 226 человек.С учётом частоты выбывания пациентов на скрининге, в группу А необходимо включитьь 752 человека, в группу Б - 251 человек. С учетом выбывания в ходе исследования на уровне 20%, в группу А необходимо включить 940 человек, в группу Б - 314 человек. 


# 4
Известно, что на фоне лечения препаратом Х рецидив псориатического артрита за 6 месяцев наблюдается в 32% случаев (ремиссия в 68%). Спонсор хочет исследовать новый препарат У, который, как ожидается, снизит частоту рецидивов на 15% (п.п.) (то есть до 17%, а частоту ремиссии поднимет до 83%). Границей превосходства можно считать снижение доли пациентов с рецидивом или повышение доли пациентов с ремиссией более, чем на 5% (п.п.). При этом существует сложность. У спонсора в наличии имеется только 250 пачек препарата Х и он просит, чтобы рандомизационное соотношение было таким, чтобы препарата хватило на проведение исследования. Выбывание на скрининге -10%, в ходе исследования -20%.    



Статистическая гипотеза превосходства в исследовании была сформулирована следующим образом:  
H0: PT – PС <= δ  
HA: PT – PС > δ  

Где PT – частота ремиссий в группе Y, PС – то же в группе X.  δ – граница превосходства (5%).  
При расчёте необходимого размера выборки были сделаны следующие допущения:  
1. Распределение в группы будет равномерным в соотношении 1:1;  
2. Односторонняя величина ошибки I рода (α) составляет 0.025;  
3. Мощность исследования должна составлять 80%, соответственно, предельная величина ошибки II рода (β) = 0.2;  
4. На основании литературных данных мы ожидаем величину эффекта в группе
препарата R 68%, в группе препарата T 83% (дельта = 15%)  
5. Граница превосходства препарата по сравнению с активным контролем равна 5%.  
Расчёт размера выборки был проведён в RStudio (версия 2025.09.2 Build 418) c использованием языка R (версия 4.5.2) с помощью функции TwoSampleProportion.NIS пакета TrialSize (версия 1.4.1). Результаты расчёта представлены далее.  


```{r}

result4 <- TwoSampleProportion.NIS(
alpha = 0.025,
beta = 0.2,
p1 = 0.83,
p2 = 0.68,
k = 1,
delta = 0.15,
margin = 0.05
)

print(result4)

result4adj <- ceiling(result4 / 0.9)

print(result4adj)

result4adj2 <- ceiling(result4adj / 0.8)

print(result4adj2)

```
получилось 392 на группу, но есть только 250 пачек препарата Х. Попробуем изменить соотношение. Путем перебора получилось соотношение У:Х 13:1. Однако, это слишком большая и нереалистичная выборка и соотношение. Может быть попробовать лучше немного снизить мощность исследования.    
При снижении мощности до 70% и установлении соотношения Х:Y=2:1 получается приемлемое значение - 495 субъектов в группе У и 495:2 = 247 в группе Х. 

```{r}

result5 <- TwoSampleProportion.NIS(
alpha = 0.025,
beta = 0.3,
p1 = 0.83,
p2 = 0.68,
k = 2,
delta = 0.15,
margin = 0.05
)

print(result5)

result5adj <- ceiling(result5 / 0.9)

print(result5adj)

result5adj2 <- ceiling(result5adj / 0.8)

print(result5adj2)

```
С другой стороны, ведь на скрининге пациенты препарат не получают, то есть если набрать в группу Х 247 пациентов, 10% выбудет на скрининге и препарат останется в избытке (его получат только 220 пациентов). Минздрав дает разрешение на определенное количество *рандомизированных* пациентов, и обычно препарат считаем именно на рандомизированных. Поэтому тут наверно логичнее посчитать кол-во пациентов просто с учетом выбывания в ходе КИ. Если немного снизить мощность и сделать соотношение 2:1, то получится как раз 500 пациентов в группу X и 250 в группу У. Возможное обоснование снижения мощности перед регулятором: изменились правила ввоза для референтного препарата из-за санкций, больше закупить не получается.   


```{r}
result6 <- TwoSampleProportion.NIS(
alpha = 0.025,
beta = 0.25,
p1 = 0.83,
p2 = 0.68,
k = 2,
delta = 0.15,
margin = 0.05
)

print(result6)

result5adj2 <- ceiling(result6 / 0.8)

print(result5adj2)
```
